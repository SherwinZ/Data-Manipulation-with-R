---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

# 1 Managing Data with dplyr

[dplyr()](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8)

## 1.1 tbl

```{r}
library(dplyr)
hflights <- tbl_df(hflights)
```

1. cuts out superluous rows, and superluous columns
2. display dimensions of the full dataset, names, and data types that is not shown
3. automatically adapt to window size
4. if dataset small enough -> display whole data
5. tbl does not change the original class of its input



**shows data types and the initial values of each column in the dataset**

```{r}
glimpse(hflights)
```



**change (back) to other data.frame**

```{r}
as.data.frame
# or
as_tibble()
```





## 1.2 combine df with a lookup table

```{r}
two <- c("AA", "AS")
lut <- C("AA" = "American",
         "AS" = "Alasks",
         "B6" = "JetBlue")

two <- lut[two]
# lut相当于python中的dict，two提供了key，并通过上面一行代码被复写

```



## 1.3 Assign a column of a df to a new object

```{r}
# 1 用列名访问
Carrier<- hflights[c("UniqueCarrier")]

# 2 用index
Carrier<- hflights[1,] #第一行
Carrier<- hflights[,2] #第二列
Carrier<- hflights[1：2] #1列和2列

# 3 Carrier<- hflights[c("UniqueCarrier")]如只访问一列，并且返回的是Vetor类型，可以用[[]]或者$来访问
Carrier<- hflights[[2]]
Carrier<- hflights$UniqueCarrier # 和Excel有点像

```



# 2 FIVE verbs or functions for datya manipulation in dyplr

select:  remove unselected columns from a dataset

filter: remove columns

arrange: = ORDER BY in SQL

mutate: uses the data to build new columns of values

summarize: 计算summary statistics



*如果variable不在列上，建议使用package tidyr

```
library(tidyr)
```



**现在设立一个业务目标： do delays tend to shrink or grow during the course of a flight**



## 2.1 select()



### EXERCISE: helper functions of [select()](http://www.rdocumentation.org/packages/dplyr/functions/select)



**Helper functions for select**
dplyr comes with a set of helper functions that can help you select groups of variables inside a select() call:
•	starts_with("X"): every name that starts with "X",
•	ends_with("X"): every name that ends with "X",
•	contains("X"): every name that contains "X",
•	matches("X"): every name that matches "X", where "X" can be a regular expression,
•	num_range("x", 1:5): the variables named x01, x02, x03, x04 and x05,
•	one_of(x): every name that appears in x, which should be a character vector.
Pay attention here: When you refer to columns directly inside select(), you don't use quotes. If you use the helper functions, you do use quotes.

Practice: 
```{r}

# 题目
# Use select() and a helper function to print out a tbl that contains just ArrDelay and DepDelay of hflights.
# Use a combination of helper functions and variable names to print out only the UniqueCarrier, FlightNum, TailNum, Cancelled, and CancellationCode columns of hflights.
# Find the most concise way to return the following columns with select and its helper functions: DepTime, ArrTime, ActualElapsedTime, AirTime, ArrDelay, DepDelay. Use only helper functions!

  
# As usual, hflights is pre-loaded as a tbl, together with the necessary libraries.

# Print out a tbl containing just ArrDelay and DepDelay
select(hflights, ends_with("Delay"))

# Print out a tbl as described in the second instruction, using both helper functions and variable names
select(hflights,UniqueCarrier, ends_with("Num"), starts_with("Cancel"))

# Print out a tbl as described in the third instruction, using only helper functions.
select(hflights, contains("Time"), contains("Delay"))
```



## 2.2 mutate()

 `mutate()` uses the information the dataset has already contained, but not display.

```R
# e.g
mutate(h1, loss = ArrDelay - DepDelay) # no need for quotes
# h1:the type of the dataframe
# loss: new column name
# =
# expression e.g. 'dose 1' + 'dose 2'

# mutate returns a modified copy of h1, so you must save the result of mutate to an object for later use
h2 <- mutate(h1, loss = ArrDelay - DepDelay)
```



does shrink or grow?

```R
mean(h2$loss, na.rm = True)

hist(h2$loss)
```



### EXERCISE 1: mutating is creating

[`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate) is the second of five data manipulation functions you will get familiar with in this course. [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate) creates new columns which are added to a copy of the dataset.

Take this example that adds a new column, `z`, which is the element-wise sum of the columns `x`and `y`, to the data frame `df`:

```
mutate(df, z = x + y)
```



- Create a new data frame, `g1`, which is the data frame `hflights` with an additional column: `ActualGroundTime`, the difference between `ActualElapsedTime` and `AirTime`.
- Extend `g1` further, by adding an additional column `GroundTime`. This column is the sum of the `TaxiIn` and `TaxiOut` columns. Store the resulting data frame in `g2`. Check in the console that the `GroundTime` and `ActualGroundTime` columns are equal.
- Add a new variable to `g2` named `AverageSpeed` that denotes the average speed that each plane flew in miles per hour. Save the resulting dataset as `g3`. Use the following formula: `60 * Distance / AirTime`.
- Print out `g3`.

- 

```{r}
# hflights and dplyr are loaded and ready to serve you.

# Add the new variable ActualGroundTime to a copy of hflights and save the result as g1.
g1 <- mutate(hflights, ActualGroundTime = ActualElapsedTime - AirTime)

# Add the new variable GroundTime to g1. Save the result as g2.
g2 <- mutate(g1, GroundTime = TaxiIn + TaxiOut)

# Add the new variable AverageSpeed to g2. Save the result as g3.
g3 <- mutate(g2, AverageSpeed = 60 * Distance / AirTime)

# Print out g3
g3
```



### EXERCISE 2: Add multiple variables using mutate

To create more than one variable, place a comma between each variable that you define inside [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate).

[`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate) even allows you to use a new variable while creating a next variable in the same call. In this example, the new variable `x` is directly reused to create the new variable `y`:

```R
mutate(my_df, x = a + b, y = x + c)
```

- Adapt the code that builds `m1`: add a variable `loss_ratio`, which is the ratio of `loss` to `DepDelay`.
- Create a tbl `m2` from `hflights` by adding three variables:
- `TotalTaxi`, which is the sum of `TaxiIn` and `TaxiOut`;
- `ActualGroundTime`, which is the difference of `ActualElapsedTime` and `AirTime`;
- `Diff`, the difference between the two newly created variables. This column should be zero for all observations!

- 

```{r}
# hflights and dplyr are ready, are you?

# Add a second variable loss_ratio to the dataset: m1
m1 <- mutate(hflights, loss = ArrDelay - DepDelay, loss_ratio = loss / DepDelay)

# Add the three variables as described in the third instruction: m2
m2 <- mutate(hflights, TotalTaxi = TaxiIn + TaxiOut, ActualGroundTime = ActualElapsedTime - AirTime, Diff = TotalTaxi - ActualGroundTime)
```



### EXERCISE 3

As of now, you mastered two of the five data manipulation functions that are at the core of `dplyr`: [`select()`](http://www.rdocumentation.org/packages/dplyr/functions/select) and [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate).

Which statement concerning the following four expressions is correct?

(A) `hflights <- select(hflights, -(Year:Month), -(DepTime:Diverted))`

(B) `select(hflights, starts_with("D"))`

(C) `select(hflights, -(Year:Month), -(DepTime:Diverted))`

(D) `hflights <- select(hflights, starts_with("Day"))`



## 2.3 filter()

**业务目标2: How many flights are cancelled in Houston in 2011**

e.g.

![1](C:\R\dyplr_datacamp\1.JPG)

```{r}
f1 <- select(hflights ,starts_with("Cancel"), DepDelay)

# Now narrow my observations to just the rows that contain a canceled flight
filter(hflights, Cancelled == 1)
# hflights: tbl
# logical test

```

R's logical operators

```
> >= == != < <= is.na !is.na
```



### EXERCISE 1: Logical operators

R comes with a set of logical operators that you can use inside [`filter()`](http://www.rdocumentation.org/packages/dplyr/functions/filter):

- `x < y`, `TRUE` if `x` is *less than* `y`
- `x <= y`, `TRUE` if `x` is *less than or equal to* `y`
- `x == y`, `TRUE` if `x` *equals* `y`
- `x != y`, `TRUE` if `x` *does not equal* `y`
- `x >= y`, `TRUE` if `x` *is greater than or equal to* `y`
- `x > y`, `TRUE` if `x` is *greater than* `y`
- `x %in% c(a, b, c)`, `TRUE` if `x` is in the vector `c(a, b, c)`

The following example filters `df` such that only the observations for which `a` is positive, are kept:

```R
filter(df, a > 0)
```

- Print out all flights in `hflights` that traveled 3000 or more miles.
- Print out all flights in `hflights` flown by JetBlue, Southwest, or Delta.
- Extract from `hflights` all flights where taxiing took longer than the actual flight. Avoid the use of [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate) and do the math directly in the logical expression of [`filter()`](http://www.rdocumentation.org/packages/dplyr/functions/filter).

- 

```{r}
# hflights is at your disposal as a tbl, with clean carrier names

# All flights that traveled 3000 miles or more
filter(hflights, Distance >= 3000)

# All flights flown by one of JetBlue, Southwest, or Delta
filter(hflights, UniqueCarrier %in% c("JetBlue", "Southwest", "Delta"))

# All flights where taxiing took longer than flying
filter(hflights, (TaxiIn + TaxiOut) > (AirTime))
```



### EXERCISE 2: Combining tests using boolean operators

R also comes with a set of boolean operators that you can use to combine multiple logical tests into a single test. These include **`&` (and), `|` (or), and `!` (not).** Instead of using the `&` operator, you can also pass several logical tests to [`filter()`](http://www.rdocumentation.org/packages/dplyr/functions/filter), separated by commas. **The following two calls are completely equivalent:**

```
filter(df, a > 0 & b > 0)
filter(df, a > 0, b > 0)
```

Next, [`is.na()`](http://www.rdocumentation.org/packages/base/functions/NA) will also come in handy. This example keeps the observations in `df` for which the variable `x` is *not* `NA`:

```
filter(df, !is.na(x))
```



**Instructions**

- Use R's logical and boolean operators to select just the rows where a flight left before 5:00 am (500) or arrived after 10:00 pm (2200).
- Print out all of the flights that departed late but arrived ahead of schedule. Use `DepDelay` and `ArrDelay` for this.
- Find all of the flights that were cancelled after being delayed. These are flights that were cancelled, while having a `DepDelay` greater than zero.

```{r}
# hflights is at your service as a tbl!

# All flights that departed before 5am or arrived after 10pm
filter(hflights, DepTime < 500 | ArrTime > 2200)

# All flights that departed late but arrived ahead of schedule
filter(hflights, DepDelay > 0 & ArrDelay <0)

# All flights that were cancelled after being delayed
filter(hflights, DepDelay > 0 & Cancelled == 1)
```



## 2.3 Blend together select(), mutate() and filter()

You will generate a new dataset from the `hflights` dataset that contains some useful information on flights that had JFK airport as their destination. You will need [`select()`](http://www.rdocumentation.org/packages/dplyr/functions/select), [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate) and [`filter()`](http://www.rdocumentation.org/packages/dplyr/functions/filter).

### EXERCISE 1

**Instructions**

- First, use [`filter()`](http://www.rdocumentation.org/packages/dplyr/functions/filter) to select the flights that had JFK as their destination and save this result to `c1`.
- Second, add a new column named `Date` to `c1`: [`paste()`](http://www.rdocumentation.org/packages/base/functions/paste) together the `Year`, `Month` and `DayofMonth` variables, separate them by a "-" by using the `sep` attribute of [`paste()`](http://www.rdocumentation.org/packages/base/functions/paste). Save the resulting data frame as `c2`.
- Finally, select some columns to provide an overview: `Date`, `DepTime`, `ArrTime` and `TailNum`, in this order. Do not assign the resulting data frame to a variable; just print it to the console.

```
# hflights is already available in the workspace

# Select the flights that had JFK as their destination: c1
c1 <- filter(hflights, Dest == "JFK")

# Combine the Year, Month and DayofMonth variables to create a Date column: c2
c2 <- mutate(c1, Date = paste(Year, Month, DayofMonth, sep = "-"))

# Print out a selection of columns of c2
select(c2, Date, DepTime, ArrTime, TailNum)
```



## 2.4 arrange()

![2](C:\R\dyplr_datacamp\2.JPG)

可以放multiple variables，输入顺序代表排序优先级。**默认升序**(从小到大)

```{r}
arrange(a1, DepDelay, ArrDelay)
```





If you pass [`arrange()`](http://www.rdocumentation.org/packages/dplyr/functions/arrange) a **character variable**, for example, R will rearrange the rows in alphabetical order according to values of the variable. 

If you pass **a factor variable**, R will rearrange the rows according to the order of the levels in your factor (running [`levels()`](http://www.rdocumentation.org/packages/base/functions/levels) on the variable reveals this order).

### levels()

#### Levels Attributes

`levels` provides access to the levels attribute of a variable. The first form returns the value of the levels of its argument and the second sets the attribute.

#### Usage

```{r}
levels(x)
levels(x) <- value
```

#### Arguments

- x

  an object, for example a factor.

- value

  A valid value for `levels(x)`. For the default method, `NULL` or a character vector. For the `factor` method, a vector of character strings with length at least the number of levels of `x`, or a named list specifying how to rename the levels.



### EXERCISE 1: Arranging your data

`dtc` has already been defined on the right. It's up to you to write some `arrange()` expressions to display its contents appropriately!

- Arrange `dtc`, by departure delays so that the shortest departure delay is at the top of the data set.
- Arrange `dtc` so that flights that were cancelled for the same reason appear next to each other.
- Arrange `dtc` so that flights by the same carrier appear next to each other. Within each carrier, flights that have smaller departure delays appear before flights that have higher departure delays. Do this in a one-liner.

```{r}
# dplyr and the hflights tbl are available

# Definition of dtc
dtc <- filter(hflights, Cancelled == 1, !is.na(DepDelay))

# Arrange dtc by departure delays
arrange(dtc, DepDelay)

# Arrange dtc so that cancellation reasons are grouped
arrange(dtc, CancellationCode)

# Arrange dtc according to carrier and departure delays
arrange(dtc, UniqueCarrier, DepDelay)
```



### EXERCISE 2: Reverse the order of arranging

改成降序: You can reverse this behavior with the [`desc()`](http://www.rdocumentation.org/packages/dplyr/functions/desc)function. [`arrange()`](http://www.rdocumentation.org/packages/dplyr/functions/arrange) will reorder the rows from *largest to smallest* values of a variable if you wrap the variable name in [`desc()`](http://www.rdocumentation.org/packages/dplyr/functions/desc) before passing it to [`arrange()`](http://www.rdocumentation.org/packages/dplyr/functions/arrange).

**Instructions**

- Arrange `hflights` so that flights by the same carrier appear next to each other and within each carrier, flights that have larger departure delays appear before flights that have smaller departure delays.
- Arrange the flights in `hflights` by their total delay (the sum of `DepDelay` and `ArrDelay`). Try to do this directly inside [`arrange()`](http://www.rdocumentation.org/packages/dplyr/functions/arrange).

```{r}
# dplyr and the hflights tbl are available

# Arrange according to carrier and decreasing departure delays
arrange(hflights, UniqueCarrier, desc(DepDelay))

# Arrange flights by total delay (normal order).
arrange(hflights, DepDelay + ArrDelay)
```



## 2.5 Summarize

create a new dataset that describes the original dataset

![3](C:\R\dyplr_datacamp\3.JPG)

### Useful Functions

- Center: `mean()`, `median()`(or `med()`)
- Spread: `sd()`, `IQR()`, `mad()`
- Range: `min()`, `max()`, `quantile()`
- Position: `first()`, `last()`, `nth()`,
- Count: `n()`, `n_distinct()`
- Logical: `any()`, `all()`

These functions are **AGGREGATE**, which means the input of these functions should take **a vector as the input** and return **a single number as the output**

R contains many *aggregating* functions, as `dplyr` calls them:

- [`min(x)`](http://www.rdocumentation.org/packages/base/functions/Extremes) - minimum value of vector `x`.

- [`max(x)`](http://www.rdocumentation.org/packages/base/functions/Extremes) - maximum value of vector `x`.

- [`mean(x)`](http://www.rdocumentation.org/packages/base/functions/mean) - mean value of vector `x`.  

  - ```{r}
    # the average arrival delay of flights whose delay is not NA
    avg_delay = mean(ArrDelay, na.rm = TRUE)
    ```

- [`median(x)`](http://www.rdocumentation.org/packages/stats/functions/median) - median value of vector `x`.

- [`quantile(x, p)`](http://www.rdocumentation.org/packages/stats/functions/quantile) - `p`th quantile of vector `x`.

- [`sd(x)`](http://www.rdocumentation.org/packages/stats/functions/sd) - standard deviation of vector `x`.

- [`var(x)`](http://www.rdocumentation.org/packages/stats/functions/cor) - variance of vector `x`.

- [`IQR(x)`](http://www.rdocumentation.org/packages/stats/functions/IQR) - Inter Quartile Range (IQR) of vector `x`.

- `diff(range(x))` - total range of vector `x`.

  - [range()](https://www.rdocumentation.org/packages/base/versions/3.5.2/topics/range)
  - [diff()](https://www.rdocumentation.org/packages/base/versions/3.5.2/topics/diff)

`dplyr` provides several helpful aggregate functions of its own, in addition to the ones that are already defined in R. These include:

- [`first(x)`](http://www.rdocumentation.org/packages/dplyr/functions/nth) - The first element of vector `x`.
- [`last(x)`](http://www.rdocumentation.org/packages/dplyr/functions/nth) - The last element of vector `x`.
- [`nth(x, n)`](http://www.rdocumentation.org/packages/dplyr/functions/nth) - The `n`th element of vector `x`.
- [`n()`](http://www.rdocumentation.org/packages/dplyr/functions/n) - The number of rows in the data.frame or group of observations that [`summarize()`](http://www.rdocumentation.org/packages/dplyr/functions/summarise)describes.
- [`n_distinct(x)`](http://www.rdocumentation.org/packages/dplyr/functions/n_distinct) - The number of unique values in vector `x`.

- you can also turn a logical test into an aggregating function with [`sum()`](http://www.rdocumentation.org/packages/base/functions/sum) or [`mean()`](http://www.rdocumentation.org/packages/base/functions/mean). A logical test returns a vector of `TRUE`'s and `FALSE`'s. When you apply [`sum()`](http://www.rdocumentation.org/packages/base/functions/sum) or [`mean()`](http://www.rdocumentation.org/packages/base/functions/mean) to such a vector, **R coerces each `TRUE` to a 1 and each `FALSE` to a 0. [`sum()`](http://www.rdocumentation.org/packages/base/functions/sum)** then represents the total number of observations that passed the test; [`mean()`](http://www.rdocumentation.org/packages/base/functions/mean)represents the proportion.

### The syntax of summarize

[`summarize()`](http://www.rdocumentation.org/packages/dplyr/functions/summarise), the last of the 5 verbs, follows the same syntax as [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate), but the resulting dataset consists of a single row instead of an entire new column in the case of [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate).

In contrast to the four other data manipulation functions, [`summarize()`](http://www.rdocumentation.org/packages/dplyr/functions/summarize) does not return an altered copy of the dataset it is summarizing; instead, it builds a new dataset that contains only the summarizing statistics.



### EXERCISE 1: 

**Instructions**

- Use `summarize()` to print out a summary of `hflights` containing two variables: `min_dist`, the shortest distance flown, and `max_dist`, the longest distance flown.
- Print out a summary of `hflights` with a single variable, `max_div`: the longest `Distance` for diverted flights. You will need one of the four other verbs to do this!

```{r}
# hflights and dplyr are loaded in the workspace

# Print out a summary with variables min_dist and max_dist
summarize(hflights, min_dist = min(Distance), max_dist = max(Distance))

# Print out a summary with variable max_div
# nested expression
summarize(filter(hflights, Diverted == 1), max_div = max(Distance))
```



### EXERCISE 2: Aggregate Functions

**Instructions**

- Remove rows that have `NA`s in the arrival delay column and save the resulting dataset to `temp1`.
- Print out a summary of `temp1` with the following variables (in this order):
- `earliest`: the minimum arrival delay,
- `average`: the average arrival delay,
- `latest`: the longest arrival delay,
- `sd`: the standard deviation for arrival delays.
- Filter `hflights` such that only rows that have no NA `TaxiIn` *and* no NA `TaxiOut` are kept; save this temporary result to `temp2`.
- Print out a summary of `temp2`, with one variable, `max_taxi_diff`: the biggest absolute difference in time between `TaxiIn` and `TaxiOut` for a single flight.

```{r}
# hflights is available

# Remove rows that have NA ArrDelay: temp1
temp1 <- filter(hflights, !is.na(ArrDelay))

# Generate summary about ArrDelay column of temp1
summarize(temp1, earliest = min(ArrDelay), average = mean(ArrDelay), latest = max(ArrDelay), sd = sd(ArrDelay))

# Keep rows that have no NA TaxiIn and no NA TaxiOut: temp2
temp2 <- filter(hflights, !is.na(TaxiIn), !is.na(TaxiOut))

# Print the maximum taxiing difference of temp2 with summarize()
summarize(temp2, max_taxi_diff = max(abs(TaxiIn - TaxiOut)))
```



### EXERCISE 3: dplyr specific aggregate functions

**Instructions**

- Print out a summary of `hflights` with the following variables:
- `n_obs`: the total number of observations,
- `n_carrier`: the total number of carriers,
- `n_dest`: the total number of destinations,
- `aa`, a tbl with all flights flown by American Airlines, is already available.
- Print out a summary of `aa` with the following variables:
- `n_flights`: the total number of flights (each observation is a flight),
- `n_canc`: the total number of cancelled flights,
- `avg_delay`: the average arrival delay of flights whose delay is not `NA` (`na.rm = TRUE`).

```{r}
# hflights is available with full names for the carriers

# Generate summarizing statistics for hflights
summarize(hflights,
          n_obs = n(),
          n_carrier = n_distinct(UniqueCarrier),
          n_dest = n_distinct(Dest))

# All American Airline flights
aa <- filter(hflights, UniqueCarrier == "American")

# Generate summarizing statistics for aa 
summarize(aa, 
          n_flights = n(),
          n_canc = sum(Cancelled),
          avg_delay = mean(ArrDelay, na.rm = TRUE))
```



# 3. Chaining your functions: the pipe operator

manipulate datasets in sophisticated ways by linking the five verbs together in new patterns.

That is, the five verbs take a tbl as the first the argument and returns a tbl, so you could link the functions together by saving a new object after each function to pass to the next function. **But the method is not very efficient.**

![4](C:\R\dyplr_datacamp\4.JPG)

- con 1: slow to type

- con 2: take up the memory of computer, slow down the analysis if the dataset is very large

Rather, I can chain my functions as below: 

```{r}
summarize(
    mutate(
        filter
            select(a, X, Y, Z),
          X > Y),
      Q = X + Y + Z),
  all = sum(Q)）
)
```

![5](C:\R\dyplr_datacamp\5.JPG)

R will work from the innermost parentheses to the outermost, **but this code is difficult to read.**

## 3.1 The pipe operator `%>%`

**So most favorably, dplyr provides a third way to link your functions together. an operator known as the *pipe*** `[%>%]`. *pronounce the pipe as "then" to smooth the expression.*

```{r}
# the pipe takes the object on its left and passes it to the function on its rights as its first arg of the func

%>%

# so no need for the first arg
object %>% function(arg1, arg2, arg3, ...)

# so rewrite the code like this

  a %>%
    select(X, Y, Z) %>%
    filter(X > Y) %>%
    mutate(Q = X + Y + Z) %>%
    summarize(all = sum(Q))
```



### EXERCISE 1: %>%

**Instructions**

Use `dplyr` functions and the pipe operator to transform the following English sentences into R code:

- Take the hflights data set *and then* ...
- Add a variable named `diff` that is the result of subtracting `TaxiIn` from `TaxiOut`, *and then*...
- Pick all of the rows whose `diff` value does not equal `NA`, *and then* ...
- Summarize the data set with a value named `avg` that is the mean `diff` value.

```{r}
# hflights and dplyr are both loaded and ready to serve you

# Write the 'piped' version of the English sentences.
hflights %>%
    mutate(diff = TaxiOut - TaxiIn) %>%
    filter(!is.na(diff)) %>%
    summarize(avg = mean(diff))
```



## 3.2 Drive or fly

You can answer sophisticated questions by combining the verbs of `dplyr`. Over the next few exercises you will examine whether it sometimes makes sense to drive instead of fly. You will begin by making a data set that contains relevant variables. Then, you will find flights whose equivalent average velocity is lower than the velocity when traveling by car.

### EXERCISE 2: part 1 of 3.2

**Instructions**

In the following instructions, you have to carry out a series of `dplyr` verbs on the `hflights`dataset. Make sure to use the `%>%` operator to chain them all together.

- mutate() the hflightsdataset and add two variables:
  - `RealTime`: the actual elapsed time plus 100 minutes (for the overhead that flying involves) and
  - `mph`: calculated as `60` times `Distance` divided by `RealTime`, then

- `filter()` to keep observations that have an `mph` that is not `NA` and that is below 70, finally
- `summarize()` the result by creating four summary variables:
  - `n_less`, the number of observations,
  - `n_dest`, the number of destinations,
  - `min_dist`, the minimum distance and
  - `max_dist`, the maximum distance.

```{r}
# Ans
# Chain together mutate(), filter() and summarize()
hflights %>%
    mutate(RealTime = ActualElapsedTime + 100, mph = 60 * Distance / RealTime) %>%
    filter(!is.na(mph) & mph < 70) %>%
    summarize(n_less = n(),
              n_dest = n_distinct(Dest),
              min_dist = min(Distance),
              max_dist = max(Distance))
```

It suggested that some flights might be less efficient than driving in terms of speed. 

### EXERCISE 3: part 2 of 3.2

But is speed all that matters? Flying imposes burdens on a traveler that driving does not. For example, airplane tickets are very expensive. Air travelers also need to limit what they bring on their trip and arrange for a pick up or a drop off. Given these burdens we might demand that a flight provide a large speed advantage over driving.

Let's define preferable flights as flights that are at least 50% faster than driving, i.e. that travel 105 mph or greater in real time. Also, assume that cancelled or diverted flights are less preferable than driving.

**Instructions**

- `filter()` the result of mutate to:
- keep observations that have an `mph` under 105 *or* for which `Cancelled` equals 1 *or* for which `Diverted` equals 1.
- `summarize()` the result by creating four summary variables:
- `n_non`, the number of observations,
- `n_dest`, the number of destinations,
- `min_dist`, the minimum distance and
- `max_dist`, the maximum distance.

```{r}
# Finish the command with a filter() and summarize() call
hflights %>%
  mutate(
    RealTime = ActualElapsedTime + 100, 
    mph = 60 * Distance / RealTime
  ) %>%
  filter(mph < 105 | Cancelled == 1 | Diverted == 1) %>%
  summarize(n_non = n(),
            n_dest = n_distinct(Dest),
            min_dist = min(Distance),
            max_dist = max(Distance))
```



## 3.3 Advanced piping

Business question: How many flights were overnight flights?

### EXERCISE 4

**Instructions**

- `filter()` the `hflights` tbl to keep only observations whose `DepTime` is not `NA`, whose `ArrTime` is not `NA` and for which `DepTime` exceeds `ArrTime`.
- Pipe the result into a `summarize()` call to create a single summary variable: `num`, that simply counts the number of observations.

```{r}
# hflights and dplyr are loaded

# Count the number of overnight flights
hflights %>%
    filter(!is.na(DepTime), !is.na(ArrTime), DepTime > ArrTime) %>% 
    # DepTime > ArrTime  说明落地时间早于起飞时间，但是这个假设了所有航班的最大飞行时间不超过24h
    summarize(num = n())
```



# 4. Get group-wise insights: dplyr's [group_by()](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8/topics/group_by)

### Get to know `group_by()`

**Group by one or more variables**

Most data operations are done on groups defined by variables. `group_by()` takes an existing tbl and converts it into a grouped tbl where operations are performed "by group". `ungroup()` removes grouping.

#### Usage

```{r}
group_by(.data, ..., add = FALSE)

ungroup(x, ...)
```



| Arguments | Explanation                                                  |
| --------- | ------------------------------------------------------------ |
| **.data** | a `tbl()`                                                    |
| **...**   | Variables to group by. All tbls accept variable names. Some tbls will accept functions of variables. **Duplicated groups will be silently dropped.** |
| **add**   | When `add = FALSE`, the default, `group_by()` will override existing groups. To add to the existing groups, use `add = TRUE`. |
| **x**     | a `tbl()`                                                    |

group_by allow me to compare group diff, it does not do much by itself, the new group information is stored as metadata associated with the table.

But when summarize(), dplyr will calculate a new summary for each group and return the result as a new tbl(). Notice that dplyr adds the grouping variable to the result automatically.

You can also group a dataset by **multiple variables**.

```{r}
hflights %>% 
    group_by(UniqueCarrier, Dest)
```

**summarize() only unwrap a layer of group at one time. To see a second level of summary, summarize the first level summary again.** Each time unwrap, the summarize() remove one grouping criteria each time you summarize, starting with the last criteria.

![6](C:\R\dyplr_datacamp\6.JPG)

![7](C:\R\dyplr_datacamp\7.JPG)

![8](C:\R\dyplr_datacamp\8.JPG)

### EXERCISE 1: Unite and conquer using group_by

In this exercise, you are going to create an ordered per-carrier summary of `hflights` by combining `group_by()`, `summarize()` and `arrange()`.

**Instructions**

- Use `group_by()` to group `hflights` by `UniqueCarrier`.
- `summarize()` the grouped tbl with two summary variables:
  - `p_canc`, the percentage of cancelled flights.
  - `avg_delay`, the average arrival delay of flights whose delay does not equal `NA`.
- Finally, order the carriers in the summary from low to high by their average arrival delay. Use percentage of flights cancelled to break any ties.

```{r}
# hflights is in the workspace as a tbl, with translated carrier names

# Make an ordered per-carrier summary of hflights
hflights %>%
  group_by(UniqueCarrier) %>%
  summarize(
    p_canc = sum(Cancelled) / n() * 100,
    avg_delay = mean(ArrDelay, na.rm = T)
  ) %>%
  arrange(avg_delay, p_canc)
```

The result:

```{r}
# A tibble: 15 x 3
   UniqueCarrier      p_canc avg_delay
   <chr>               <dbl>     <dbl>
 1 US_Airways          1.18     -1.07 
 2 Mesa               14.3      -0.833
 3 American            1.59     -0.116
 4 AirTran             0.889     0.712
 5 Alaska              0         1.06 
 6 Frontier            0         4    
 7 JetBlue             4.17      4    
 8 Continental         0.717     6.08 
 9 Atlantic_Southeast  3.06      6.29 
10 United              2.58      6.59 
11 Delta               2.07      7.14 
12 Southwest           1.62      7.53 
13 ExpressJet          1.53      7.61 
14 American_Eagle      1.81      7.81 
15 SkyWest             1.61      9.16
```



### EXERCISE2: Combine group_by with `mutate()`

When you mutate grouped data, [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate)will calculate the new variables independently for each group. This is particularly useful when [`mutate()`](http://www.rdocumentation.org/packages/dplyr/functions/mutate) uses the [`rank()`](http://www.rdocumentation.org/packages/base/functions/rank) function, that calculates within-group rankings. [`rank()`](http://www.rdocumentation.org/packages/base/functions/rank) takes a group of values and calculates the rank of each value within the group, e.g.

```{r}
rank(c(21, 22, 24, 23))
```

has output

```{r}
[1] 1 2 4 3
```

As with [`arrange()`](http://www.rdocumentation.org/packages/dplyr/functions/arrange), [`rank()`](http://www.rdocumentation.org/packages/base/functions/rank) ranks values from the smallest to the largest.

**Instructions**

- `filter()` the `hflights` tbl to only keep observations for which `ArrDelay` is not `NA` and positive.
- Use `group_by()` on the result to group by `UniqueCarrier`.
- Next, use `summarize()` to calculate the average `ArrDelay` per carrier. Call this summary variable `avg`.
- Feed the result into a `mutate()` call: create a new variable, `rank`, calculated as `rank(avg)`.
- Finally, arrange by this new `rank` variable

```{r}
# dplyr is loaded, hflights is loaded with translated carrier names

# Ordered overview of average arrival delays per carrier
hflights %>%
    filter(!is.na(ArrDelay), ArrDelay > 0) %>%
    group_by(UniqueCarrier) %>%
    summarize(avg = mean(ArrDelay)) %>%
    mutate(rank = rank(avg)) %>%
    arrange(rank)
```

The result:

```{r}
# A tibble: 15 x 3
   UniqueCarrier        avg  rank
   <chr>              <dbl> <dbl>
 1 Frontier            13.4     1
 2 Mesa                14       2
 3 US_Airways          20.2     3
 4 Continental         21.8     4
 5 American            23.1     5
 6 ExpressJet          23.5     6
 7 SkyWest             24.3     7
 8 Southwest           25.2     8
 9 AirTran             26.3     9
10 United              28.0    10
11 Alaska              28.3    11
12 Delta               34.0    12
13 JetBlue             36.6    13
14 American_Eagle      39.1    14
15 Atlantic_Southeast  39.2    15
```

### EXERCISE3: Advanced group_by exercises

The next challenges are an all-encompassing review of the concepts you have learned about. Up to you to finish all `dplyr` calls! For simplicity, you can include cancelled flights in your answers, so you shouldn't filter based on the `Cancelled` column.

**Instructions**

- How many airplanes flew to only one destination? The tbl you print out should have a single column, named `nplanes` and a single row.
- Find the most visited destination for each carrier. The tbl you print out should contain four columns:
- `UniqueCarrier` and `Dest`,
- `n`, how often a carrier visited a particular destination,
- `rank`, how each destination ranks per carrier. `rank` should be 1 for every row, as you want to find the most visited destination for each carrier.

```{r}
# dplyr and hflights (with translated carrier names) are pre-loaded

# How many airplanes only flew to one destination?
hflights %>%
  group_by(TailNum) %>%
  summarize(ndest = n_distinct(Dest)) %>% # 不重复的目的地数量
  filter(ndest == 1) %>%
  summarize(nplanes = n())

# Find the most visited destination for each carrier
hflights %>%
  group_by(UniqueCarrier, Dest) %>%
  summarize(n = n()) %>%
  mutate(rank = rank(desc(n))) %>% # 降序，最大的ob的rank为1
  filter(rank == 1)
```

The result:

```{r}
# A tibble: 1 x 1
  nplanes
    <int>
1    1039

# A tibble: 15 x 4
# Groups:   UniqueCarrier [15]
   UniqueCarrier      Dest      n  rank
   <chr>              <chr> <int> <dbl>
 1 AirTran            ATL     211     1
 2 Alaska             SEA      32     1
 3 American           DFW     186     1
 4 American_Eagle     DFW     234     1
 5 Atlantic_Southeast DTW      89     1
 6 Continental        LAX     417     1
 7 Delta              ATL     219     1
 8 ExpressJet         CRP     313     1
 9 Frontier           DEN      78     1
10 JetBlue            JFK      72     1
11 Mesa               CLT       6     1
12 SkyWest            COS     143     1
13 Southwest          DAL     839     1
14 US_Airways         CLT     237     1
15 United             ORD      59     1
```



# 5. dplyr and databases

We've leaned to manipulate data frame, now manipulate **data table or database** using dplyr

Connect to a database and manipulate it as does other `tbl()`.

## 5.1 dplyr and data table

### EXERCISE 1: dplyr deals with different types

**Instructions**

`hflights2` is a copy of `hflights` that is saved as a data table. `hflights2` was made available in the background using the following code:

```
library(data.table)
hflights2 <- as.data.table(hflights)
```

`hflights2` contains all of the same information as `hflights`, but the information is stored in a different data structure. You can see this structure by typing `hflights2` at the command line.

Even though `hflights2` is a different data structure, you can use the same `dplyr` functions to manipulate `hflights2` as you used to manipulate `hflights`.

- Use [`summarize()`](http://www.rdocumentation.org/packages/dplyr/functions/summarise) to calculate `n_carrier`, the total number of unique carriers in `hflights2`. Whether or not you use the pipe is up to you!

```{r}
# hflights2 is pre-loaded as a data.table

# Use summarize to calculate n_carrier
hflights2 %>% 
    summarize(n_carrier = n_distinct(UniqueCarrier))
```

## 5.2 dplyr and mySQL databases

DataCamp hosts a mySQL database with data about flights that departed from New York City in 2013. The data is similar to the data in `hflights`, but it does not contain information about cancellations or diversions. With the `tbl()` function, we already created a reference to a table in this information.

Although `nycflights` is a reference to data that lives outside of R, you can use the `dplyr`commands on them as usual. Behind the scenes, `dplyr` will convert the commands to the database's native language (in this case, SQL), and return the results. This allows you to pull data that is too large to fit in R: only the fraction of the data that you need will actually be downloaded into R, which will usually fit into R without memory issues.

```{r}
# Set up a connection to the mysql database
my_db <- src_mysql(dbname = "dplyr", 
                   host = "courses.csrrinzqubik.us-east-1.rds.amazonaws.com", 
                   port = 3306, 
                   user = "student",
                   password = "datacamp")

# Reference a table within that source: nycflights
nycflights <- tbl(my_db, "dplyr")
```



### EXERCISE 2:

**Instructions**

- Try to understand the code that creates `nycflights`, a reference to a MySQL table.
- Use `glimpse()` to check out `nycflights`. Although `nycflights` is a reference to a tbl in a remote database, there is no difference in syntax. Look carefully: the variable names in `nycflights` differ from the ones in `hflights`!
- Group `nycflights` data by `carrier`, then `summarize()` with two variables: `n_flights`, the number of flights flown by each carrier and `avg_delay`, the average arrival delay of flights flown by each carrier. Finally, arrange the carriers by average delay from low to high.

```{r}
# glimpse at nycflights
glimpse(nycflights)

# Ordered, grouped summary of nycflights
nycflights %>%
    group_by(carrier) %>%
    summarize(n_flights = n(), avg_delay = mean(arr_delay)) %>%
    arrange(avg_delay)
```

